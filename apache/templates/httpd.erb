# MANAGED BY PUPPET!
### Section 1: Global Environment
<% if @servertokens and ! @servertokens.empty? -%>
ServerTokens <%= @servertokens %>
<% else -%>
ServerTokens OS
<% end -%>

ServerRoot "/etc/httpd"

<% if @pidfile and ! @pidfile.empty? -%>
PidFile <%= @pidfile %>
<% else -%>
PidFile run/httpd.pid
<% end -%>

Timeout 60

<% if @keepalive and ! @keepalive.empty? -%>
KeepAlive <%= @keepalive %>
<% else -%>
KeepAlive Off
<% end -%>

<% if @maxkeepaliverequests and ! @maxkeepaliverequests.empty? -%>
MaxKeepAliveRequests <%= @maxkeepaliverequests %>
<% else -%>
MaxKeepAliveRequests 100
<% end -%>

<% if @keepalivetimeout and ! @keepalivetimeout.empty? -%>
KeepAliveTimeout <%= @keepalivetimeout %>
<% else -%>
KeepAliveTimeout 15
<% end -%>

<IfModule prefork.c>
<% if @startservers and ! @startservers.empty? -%>
StartServers <%= @startservers %>
<% else -%>
StartServers           8
<% end -%>
<% if @minspareservers and ! @minspareservers.empty? -%>
MinSpareServers <%= @minspareservers %>
<% else -%>
MinSpareServers        5
<% end -%>
<% if @maxspareservers and ! @maxspareservers.empty? -%>
MaxSpareServers <%= @maxspareservers %>
<% else -%>
MaxSpareServers       20
<% end -%>
<% if @serverlimit and ! @serverlimit.empty? -%>
ServerLimit <%= @serverlimit %>
<% else -%>
ServerLimit          256
<% end -%>
<% if @maxclients and ! @maxclients.empty? -%>
MaxClients <%= @maxclients %>
<% else -%>
MaxClients           256
<% end -%>
<% if @maxrequestsperchild and ! @maxrequestsperchild.empty? -%>
MaxRequestsPerChild <%= @maxrequestsperchild %>
<% else -%>
MaxRequestsPerChild 4000
<% end -%>
</IfModule>

<IfModule worker.c>
<% if @startservers and ! @startservers.empty? -%>
StartServers <%= @startservers %>
<% else -%>
StartServers           4
<% end -%>
<% if @maxclients and ! @maxclients.empty? -%>
MaxClients <%= @maxclients %>
<% else -%>
MaxClients           300
<% end -%>
<% if @minsparethreads and ! @minsparethreads.empty? -%>
MinSpareThreads <%= @minsparethreads %>
<% else -%>
MinSpareThreads       25
<% end -%>
<% if @maxsparethreads and ! @maxsparethreads.empty? -%>
MaxSpareThreads <%= @maxsparethreads %>
<% else -%>
MaxSpareThreads       75
<% end -%>
<% if @threadsperchild and ! @threadsperchild.empty? -%>
ThreadsPerChild <%= @threadsperchild %>
<% else -%>
ThreadsPerChild       25
<% end -%>
<% if @maxrequestsperchild and ! @maxrequestsperchild.empty? -%>
MaxRequestsPerChild <%= @maxrequestsperchild %>
<% else -%>
MaxRequestsPerChild    0
<% end -%>
</IfModule>

<% if @listen and ! @listen.empty? -%>
<% @listen.each do |l| -%>
Listen <%= l %>
<% end -%>
<% else -%>
Listen 80
<% end -%>

LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule auth_digest_module modules/mod_auth_digest.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_alias_module modules/mod_authn_alias.so
LoadModule authn_anon_module modules/mod_authn_anon.so
LoadModule authn_dbm_module modules/mod_authn_dbm.so
LoadModule authn_default_module modules/mod_authn_default.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule authz_owner_module modules/mod_authz_owner.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_dbm_module modules/mod_authz_dbm.so
LoadModule authz_default_module modules/mod_authz_default.so
LoadModule ldap_module modules/mod_ldap.so
LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
LoadModule include_module modules/mod_include.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule logio_module modules/mod_logio.so
LoadModule env_module modules/mod_env.so
LoadModule ext_filter_module modules/mod_ext_filter.so
LoadModule mime_magic_module modules/mod_mime_magic.so
LoadModule expires_module modules/mod_expires.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule headers_module modules/mod_headers.so
LoadModule usertrack_module modules/mod_usertrack.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule mime_module modules/mod_mime.so
#LoadModule dav_module modules/mod_dav.so
LoadModule status_module modules/mod_status.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule info_module modules/mod_info.so
#LoadModule dav_fs_module modules/mod_dav_fs.so
LoadModule vhost_alias_module modules/mod_vhost_alias.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule dir_module modules/mod_dir.so
LoadModule actions_module modules/mod_actions.so
LoadModule speling_module modules/mod_speling.so
LoadModule userdir_module modules/mod_userdir.so
LoadModule alias_module modules/mod_alias.so
LoadModule substitute_module modules/mod_substitute.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
#LoadModule proxy_ftp_module modules/mod_proxy_ftp.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
LoadModule proxy_connect_module modules/mod_proxy_connect.so
LoadModule cache_module modules/mod_cache.so
LoadModule suexec_module modules/mod_suexec.so
LoadModule disk_cache_module modules/mod_disk_cache.so
LoadModule cgi_module modules/mod_cgi.so
LoadModule version_module modules/mod_version.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
#LoadModule asis_module modules/mod_asis.so
#LoadModule authn_dbd_module modules/mod_authn_dbd.so
#LoadModule cern_meta_module modules/mod_cern_meta.so
#LoadModule cgid_module modules/mod_cgid.so
#LoadModule dbd_module modules/mod_dbd.so
#LoadModule dumpio_module modules/mod_dumpio.so
#LoadModule filter_module modules/mod_filter.so
#LoadModule ident_module modules/mod_ident.so
#LoadModule log_forensic_module modules/mod_log_forensic.so
LoadModule unique_id_module modules/mod_unique_id.so

Include conf.d/*.conf

<% if @extendedstatus and ! @extendedstatus.empty? -%>
ExtendedStatus <%= @extendedstatus %>
<% else -%>
#ExtendedStatus On
<% end -%>

<% if @user and ! @user.empty? -%>
User <%= @user %>
<% else -%>
User apache
<% end -%>
<% if @group and ! @group.empty? -%>
Group <%= @group %>
<% else -%>
Group apache
<% end -%>

### Section 2: 'Main' server configuration
<% if @serveradmin and ! @serveradmin.empty? -%>
ServerAdmin <%= @serveradmin %>
<% else -%>
ServerAdmin root@<%= @fqdn %>
<% end -%>

ServerName <%= @fqdn %>

<% if @usecanonicalname and ! @usecanonicalname.empty? -%>
UseCanonicalName <%= @usecanonicalname %>
<% else -%>
UseCanonicalName Off
<% end -%>

<% if @documentroot and ! @documentroot.empty? -%>
DocumentRoot "<%= @documentroot %>"
<% else -%>
DocumentRoot "/var/www/html"
<% end -%>

<Directory />
    Options FollowSymLinks
    AllowOverride None
</Directory>

<% if @documentroot and ! @documentroot.empty? -%>
<Directory "<%= @documentroot %>">
<% else -%>
<Directory "/var/www/html">
<% end -%>
<% if @options and ! @options.empty? -%>
    Options <% @options.each do |o| -%><%= o %> <% end -%>
<% else -%>
    Options Indexes FollowSymLinks
<% end -%>

<% if @allowoverride and ! @allowoverride.empty? -%>
    AllowOverride <% @allowoverride.each do |ao| -%><%= ao %> <% end -%>
<% else -%>
    AllowOverride None
<% end -%>

<% if @order and ! @order.empty? -%>
    Order <%= @order %>
<% else -%>
    Order allow,deny
<% end -%>
<% if @allow and ! @allow.empty? -%>
<% @allow.each do |al| -%>
    Allow from <%= al %>
<% end -%>
<% else -%>
    Allow from all
<% end -%>
<% if @deny and ! @deny.empty? -%>
<% @deny.each do |de| -%>
    Deny from <%= de %>
<% end -%>
<% end -%>
</Directory>

<% if @directoryindex and ! @directoryindex.empty? -%>
DirectoryIndex <% @directoryindex.each do |di| -%><%= di %> <% end -%>
<% else -%>
DirectoryIndex index.html index.html.var
<% end -%>

AccessFileName .htaccess

<Files ~ "^\.ht">
    Order allow,deny
    Deny from all
    Satisfy All
</Files>

<DirectoryMatch "\.(git|hg|svn)">
    Order allow,deny
    Deny from all
    Satisfy All
</DirectoryMatch>

TypesConfig /etc/mime.types

DefaultType text/plain

<IfModule mod_mime_magic.c>
    MIMEMagicFile conf/magic
</IfModule>

HostnameLookups Off

ErrorLog "|/usr/sbin/rotatelogs /var/log/httpd/error_log_%Y%m%d 86400"

LogLevel warn

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common

LogFormat "%V %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" vcombined
LogFormat "%V %h %l %u %t \"%r\" %>s %b" vcommon

LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

<% if @logformat and ! @logformat.empty? -%>
<% @logformat.each do |lf| -%>
LogFormat <%= lf %>
<% end -%>
<% end -%>

CustomLog "|/usr/sbin/rotatelogs /var/log/httpd/access_log_%Y%m%d 86400" combined

<% if @serversignature and ! @serversignature.empty? -%>
ServerSignature <%= @serversignature %>
<% else -%>
ServerSignature Off
<% end -%>

AddDefaultCharset UTF-8

AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz

AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl

Header unset ETag
FileETag MTime Size

TraceEnable off

<IfModule reqtimeout_module>
RequestReadTimeout header=10-20,minrate=500
RequestReadTimeout body=10,minrate=500
</IfModule>

### Section 3: Virtual Hosts
<% if @namevirtualhost and ! @namevirtualhost.empty? -%>
<% @namevirtualhost.each do |n| -%>
NameVirtualHost <%= n %>
<% end -%>
<% else -%>
#NameVirtualHost *:80
<% end -%>

<% if @namevirtualhost and ! @namevirtualhost.empty? -%>
Include vhost.d/*.conf
<% end -%>
